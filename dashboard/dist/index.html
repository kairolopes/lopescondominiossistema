<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lopes Condomínios - CRM Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { height: 100vh; background-color: #2c3e50; color: white; padding-top: 20px; }
        .sidebar a { color: #bdc3c7; text-decoration: none; display: block; padding: 10px 20px; }
        .sidebar a:hover, .sidebar a.active { background-color: #34495e; color: white; }
        .chat-list { height: calc(100vh - 100px); overflow-y: auto; border-right: 1px solid #dee2e6; }
        .chat-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-item:hover { background-color: #f8f9fa; }
        .chat-item.active { background-color: #e9ecef; }
        .chat-window { height: calc(100vh - 100px); display: flex; flex-direction: column; }
        .messages-area { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: white; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; }
        .message-sent { background-color: #dcf8c6; align-self: flex-end; margin-left: auto; }
        .message-received { background-color: #f1f0f0; align-self: flex-start; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar">
            <h4 class="text-center mb-4">Lopes CRM</h4>
            <a href="#" class="active"><i class="fas fa-comments me-2"></i> Atendimentos</a>
            <a href="#"><i class="fas fa-bullhorn me-2"></i> Campanhas</a>
            <a href="#"><i class="fas fa-users me-2"></i> Contatos</a>
            <a href="#"><i class="fas fa-cog me-2"></i> Configurações</a>
        </div>

        <!-- Main Content -->
        <div class="col-md-10">
            <!-- Header -->
            <div class="row bg-white shadow-sm p-3 mb-3 align-items-center">
                <div class="col">
                    <h5 class="m-0">Central de Atendimento</h5>
                </div>
                <div class="col-auto">
                    <span class="badge bg-success">Online</span>
                </div>
            </div>

            <div class="row bg-white shadow-sm rounded mx-1" style="height: 85vh;">
                <!-- Chat List -->
                <div class="col-md-4 chat-list p-0" id="conversationList">
                    <div class="text-center p-3 text-muted">Carregando conversas...</div>
                </div>

                <!-- Chat Window -->
                <div class="col-md-8 chat-window p-0">
                    <div class="messages-area d-flex flex-column" id="messagesArea">
                        <div class="text-center mt-5 text-muted">Selecione uma conversa para iniciar</div>
                    </div>
                    <!-- Input Area (Visual Only for now) -->
                    <div class="p-3 border-top bg-light">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Digite sua mensagem...">
                            <button class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Configuration
    const API_BASE = '/api/admin';
    let currentPhone = null;

    // Fetch Token (Mock for now, assumes token is in localStorage or handles auth error)
    // For this MVP, we'll try to fetch without token or assume cookie auth if implemented.
    // NOTE: The backend requires 'authenticateJWT'. We need a login page or a temporary bypass.
    // For now, let's assume the user has a token or we need to implement login.
    // Since we don't have a login page yet, this might fail with 401. 
    // I'll add a simple prompt for token if 401 occurs, or just try.
    const token = localStorage.getItem('token'); 

    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };

    async function loadConversations() {
        try {
            const response = await fetch(`${API_BASE}/conversations`, { headers });
            if (response.status === 401) {
                document.getElementById('conversationList').innerHTML = '<div class="p-3 text-danger">Não autorizado. Faça login.</div>';
                return;
            }
            const conversations = await response.json();
            
            const listEl = document.getElementById('conversationList');
            listEl.innerHTML = '';

            if (conversations.length === 0) {
                listEl.innerHTML = '<div class="p-3 text-muted text-center">Nenhuma conversa encontrada.</div>';
                return;
            }

            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                const date = new Date(conv.lastActivity._seconds * 1000);
                item.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <strong>${conv.senderName || conv.phone}</strong>
                        <small class="text-muted">${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                    </div>
                    <div class="text-truncate text-muted small">${conv.lastMessage || ''}</div>
                `;
                item.onclick = () => loadMessages(conv.phone, item);
                listEl.appendChild(item);
            });
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('conversationList').innerHTML = '<div class="p-3 text-danger">Erro ao carregar.</div>';
        }
    }

    async function loadMessages(phone, element) {
        // Highlight active
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        currentPhone = phone;
        const area = document.getElementById('messagesArea');
        area.innerHTML = '<div class="text-center mt-5 text-muted">Carregando mensagens...</div>';

        try {
            const response = await fetch(`${API_BASE}/conversations/${phone}/messages`, { headers });
            const messages = await response.json();
            
            area.innerHTML = '';
            messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.role === 'assistant' ? 'message-sent' : 'message-received'}`;
                bubble.textContent = msg.content;
                
                // Optional: Add timestamp tooltip
                bubble.title = new Date(msg.timestamp).toLocaleString();
                
                area.appendChild(bubble);
            });
            
            // Scroll to bottom
            area.scrollTop = area.scrollHeight;

        } catch (error) {
            console.error('Error:', error);
            area.innerHTML = '<div class="text-center text-danger">Erro ao carregar mensagens.</div>';
        }
    }

    // Initial Load
    loadConversations();
    
    // Auto-refresh every 10s
    setInterval(loadConversations, 10000);
    
</script>

</body>
</html>
